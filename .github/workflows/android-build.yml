name: Build APK from ZIP

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  ZIP_NAME: Neuro-Lab-Agent.zip

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y unzip curl

      - name: Unzip project
        run: |
          if [ ! -f "$ZIP_NAME" ]; then
            echo "ZIP não encontrado: $ZIP_NAME"
            ls -la
            exit 1
          fi
          rm -rf extracted
          unzip -o "$ZIP_NAME" -d extracted
          echo "Conteúdo extraído:"
          ls -la extracted || true

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3

      - name: Locate project directory
        id: locate
        run: |
          PROJECT_FILE="$(find extracted -maxdepth 10 -type f '(' -name settings.gradle -o -name settings.gradle.kts ')' | head -n 1)"
          if [ -z "$PROJECT_FILE" ]; then
            echo "settings.gradle não encontrado dentro do ZIP"
            find extracted -maxdepth 3 -type f | head -n 200
            exit 1
          fi
          PROJECT_DIR="$(dirname "$PROJECT_FILE")"
          echo "project_dir=$PROJECT_DIR" >> "$GITHUB_OUTPUT"
          echo "Diretório do projeto: $PROJECT_DIR"

      - name: Build Debug APK
        run: |
          PROJECT_DIR="${{ steps.locate.outputs.project_dir }}"
          GRADLEW_PATH="$(find "$PROJECT_DIR" -maxdepth 2 -type f -name gradlew | head -n 1)"

          if [ -n "$GRADLEW_PATH" ]; then
            echo "Usando gradlew"
            chmod +x "$GRADLEW_PATH"
            cd "$(dirname "$GRADLEW_PATH")"
            ./gradlew assembleDebug --no-daemon --stacktrace
          else
            echo "gradlew não encontrado, usando Gradle manual"
            cd "$PROJECT_DIR"
            curl -sLo gradle.zip https://services.gradle.org/distributions/gradle-8.7-bin.zip
            unzip -q gradle.zip -d "$HOME/gradle"
            export PATH="$HOME/gradle/gradle-8.7/bin:$PATH"
            gradle -v
            gradle assembleDebug --no-daemon --stacktrace
          fi

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: NeuroLabAgent-APK
          path: "**/app/build/outputs/apk/debug/app-debug.apk"
